# Мониторинг телефонных событий
## Собственно задача такая: 
у нас есть
 * https://github.com/spo0okie/ast-lite, который пишет разговоры
 * https://github.com/spo0okie/ast-ami, который через AMI ловит ивенты и отправляет в
 * промежуточный сервис для перенаправления событий от ast-ami, чот я его не выложил на хаб. Но он сам не нужен. нужен только REST API от него, т.к. он уже реализован в ast-ami
 
Нам надо 
 * получать **понятный** лог звонка
 * отправлять герененные события о завершении вызова, которые не отправляет ast-ami
## Решение
Что точно должно быть без вариантов - это БД по типу CDR и какое-то API для записи в нее и с обработчиками событий

### Вариант 1 - макросы
отправлять все события в API из макросов
+ не нужно внешних сервисов
- была проблема с обнаружением событий окончания вызова

### Вариант 2 - формирование своей ИС для взаимодействия с ast-ami
+ не нужно трогать код, который уже хорошо работает
+ какая-то внешня ИС в любом случае нужна чтобы работать с БД
- зависимость CDR от внешних процессов

### Вариант 3 - прикрутить свой обработчик в строенному CDR астериска
к сожалению я там не нашел какого-то удобного способа прикрутить свой API  
https://asterisk-pbx.ru/wiki/asterisk/cf/cdr  
можно пытаться вешать обработчики внутрь БД или на syslog, но что-то мне это видится как совсем уж гора костылей

## Реализация
Самый короткий путь для получения результата - вариант 2
Закрывать недостатки можно попытаясь сравнивать CDR asterisk и собственный и дополнять свой задним числом. Естественно события будут потеряны, но CDR будет консистентным. Возможно для полного восстановления истории надо будет использовать вариант 1 чтобы частично наполнять свой CDR прямо из диалплана.
резервная схема - 1:

# Журнальчик
Короче сделал вроде все как было в AST-AMI, но пока все равно много шума. надо фильтровать поток данных:  
Изначально можно определить у звонка откуда куда позвонили и в цепочке прибить гвоздями src и trunk  
Также наверно надо записывать короткие логи внутриь chanEvents для упрощения отладки
